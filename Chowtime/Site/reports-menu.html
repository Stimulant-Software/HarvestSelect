<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
        <link href="content/global.css" rel="stylesheet" type="text/css">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof jQuery == 'undefined') { document.write(unescape("%3Cscript src='/scripts/jquery-1.10.2.min.js' type='text/javascript'%3E%3C/script%3E")); }
    </script>
    <script src="scripts/underscore.min.js"></script>
</head>
<body>
    Hello
    <div id="headerDiv">
        <table>
            <thead>
                <tr>
                    <th>farm</th>
                    <th>pond</th>
                    <th>date</th>
                    <th>range</th>
                    <th>value</th>
                    <th>weight</th>
                </tr>
            </thead>
        </table>
    </div>
    <div id="resultsDiv">
        <table id="resultsTable">
            <tbody></tbody>
        </table>
    </div>
    <div>
        <span>start date:</span><input type="date" id="startDateInput" />
    </div>
    <div>
        <span>end date:</span><input type="date" id="endDateInput" />
    </div>
    <div id="keithsDataDiv"></div>
    <button id="getDataButton">Get Data</button>
    <footer></footer>
        <script type="text/javascript" src="scripts/functions.js"></script>
    <script type="text/javascript" src="scripts/highcharts.js"></script>
    <script type="text/javascript" src="scripts/at-functions.js"></script>
    <script>
    $(document).ready(function () {
        var $button = $("#getDataButton");
        $button.on("click", function () {
            var qry = {
                "Key": "Hello World",
                "startDate": $("#startDateInput").val(),
                "endDate": $("#endDateInput").val()
            };
            var address = "../api/JMremote/GetRemoteData";
            var data = JSON.stringify(qry),
                dta = {};
            $.ajax(address, {
                type: 'POST',
                data: data,
                success: function (msg) {
                    var a = [];
                    var categories = [];
                    var weights = [];
                    dta = JSON.parse(msg);
                    var groups = _(dta).groupBy(function (value) {
                        return value.farmPond + value.rangeName;
                    });
                    if (groups !== undefined) {
                        _(groups).each(function (value) {
                            var tot = _(value).reduce(function (memo, val) {
                                return memo + val.weight;
                            }, 0);
                            var obj = {
                                farmPond: value[0].farmPond,
                                rangeName: value[0].rangeValue,
                                weight: tot
                            };
                            weights.push(obj.weight);
                            a.push(obj);
                            categories.push(obj.farmPond + ' ' + obj.rangeName);
                        });
                    }
                    var html = "";
                    var $keithsDataDiv = $("#keithsDataDiv");
                    console.log(categories);
                    $keithsDataDiv.highcharts({
                        chart: {
                            zoomType: 'xy', alignTicks: false, type: "column"
                        },
                        title: { text: "Keith's Data" },
                        xAxis: [{ categories: categories, labels: { enabled: false } }],
                        yAxis: [{ labels: { format: '{value}', style: { color: '#89A54E' } }, title: { text: "weight" } }],
                        plotOptions: { column: { stacking: null } },
                        series: [{ name: 'Farm Ponds', data:  weights}]
                    });
                    var $resultsTable = $("#resultsTable");
                    $resultsTable.find("tbody").empty();
                    _(a).each(function (value) {
                        html += '<tr><td>' + value.farmPond + '</td><td>' + value.rangeName + '</td><td>' + value.weight + '</td></tr>';
                    });
                    $resultsTable.find("tbody").html(html);
                }
            });
        });
    })
    </script>

</body>
</html>
